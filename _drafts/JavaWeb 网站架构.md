[TOC]



# 初始搭建

应用程序、文件服务、数据库部署在同一台服务器。

![](https://blog.52itstyle.com/usr/uploads/2017/08/1296156616.png)



# 服务分离

用户量增大，横向扩展，增加机器，将数据库服务和文件服务单独部署。

![](https://blog.52itstyle.com/usr/uploads/2017/08/3243270291.png)





# 反向代理

在tomcat服务器前加一个代理服务器，提升服务能力，用户的请求先发送到反向代理，然后反向代理把请求转发到后端服务器。

严格讲，Nginx属于Web服务器，一般用于处理静态html、css、js请求，Tomcat属于Web容器，专门处理Jsp请求，Tomcat也是支持html的，只是效果没Nginx好而已。

![](https://blog.52itstyle.com/usr/uploads/2017/08/1537593540.png?_=7476838)

反向代理的优势，如下：

- 隐藏真实后端服务
- 负载均衡集群
- 高可用集群
- 缓存静态内容实现动静分离
- 安全限流
- 静态文件压缩
- 解决多个服务跨域问题
- 合并静态请求(HTTP/2.0后已经被弱化)
- 防火墙
- SSL以及http2



# 动静分离

基于Nginx反向代理，静态请求如html、css、js交给Nginx 处理，动态请求分发给后端Tomcat 处理。

Nginx 升级到1.9.5+可以开启HTTP/2.0时代，加速网站访问。

CND也可以实现。

![](https://blog.52itstyle.com/usr/uploads/2017/08/2761933616.png?_=7476838)



# 服务拆分

### Dubbo

![](https://blog.52itstyle.com/usr/uploads/2017/09/1427006707.png?_=7476838)

### SpringCloud

- 服务发现——Netflix Eureka
- 客服端负载均衡——Netflix Ribbon
- 断路器——Netflix Hystrix
- 服务网关——Netflix Zuul
- 分布式配置——Spring Cloud Config

### 微服务与轻量级通信

- 同步通信和异步通信
- 远程调用RPC
- REST
- 消息队列



# 持续集成部署

拆分服务后，需要持续部署，使用以下工具：

Docker、Jenkins、Git、Maven

基本拓扑结构：

![](https://blog.52itstyle.com/usr/uploads/2017/09/433394025.png?_=7476838)

整个持续集成平台架构演进到如下图所示：

![](https://blog.52itstyle.com/usr/uploads/2017/09/3466067041.png?_=7476838)

# 服务集群

Linux集群主要分成三大类( 高可用集群， 负载均衡集群，科学计算集群)。最常见的为负载均衡集群。

![](https://blog.52itstyle.com/usr/uploads/2017/08/2148006274.png?_=7476838)





### 负载均衡实现

- DNS负载均衡，一般域名注册商的dns服务器不支持，但博主用的阿里云解析已经支持
- 四层负载均衡(F5、LVS)，工作在TCP协议下
- 七层负载均衡(Nginx、haproxy)，工作在Http协议下

### 分布式session

大家都知道，服务一般分为有状态和无状态，而分布式sessoion就是针对有状态的服务。

#### 分布式Session的几种实现方式

- 基于数据库的Session共享
- 基于resin/tomcat web容器本身的session复制机制
- 基于oscache/Redis/memcached 进行 session 共享。
- 基于cookie 进行session共享

#### 分布式Session的几种管理方式

- Session Replication 方式管理 (即session复制)

  **简介**：将一台机器上的Session数据广播复制到集群中其余机器上
  **使用场景**：机器较少，网络流量较小
  **优点**：实现简单、配置较少、当网络中有机器Down掉时不影响用户访问
  **缺点**：广播式复制到其余机器有一定廷时，带来一定网络开销

- Session Sticky 方式管理

  **简介**：即粘性Session、当用户访问集群中某台机器后，强制指定后续所有请求均落到此机器上
  **使用场景**：机器数适中、对稳定性要求不是非常苛刻
  **优点**：实现简单、配置方便、没有额外网络开销
  **缺点**：网络中有机器Down掉时、用户Session会丢失、容易造成单点故障

- 缓存集中式管理

  **简介**：将Session存入分布式缓存集群中的某台机器上，当用户访问不同节点时先从缓存中拿Session信息
  **使用场景**：集群中机器数多、网络环境复杂
  **优点**：可靠性好
  **缺点**：实现复杂、稳定性依赖于缓存的稳定性、Session信息放入缓存时要有合理的策略写入

##### 目前生产中使用到的

- 基于tomcat配置实现的MemCache缓存管理session实现(麻烦)
- 基于OsCache和shiro组播的方式实现(网络影响)
- 基于spring-session+redis实现的(最适合)

#### 负载均衡策略

负载均衡策略的优劣及其实现的难易程度有两个关键因素：一、负载均衡算法，二、对网络系统状况的检测方式和能力。



| 方式                                       | 优点                | 缺点            |
| ---------------------------------------- | ----------------- | ------------- |
| rr 轮询调度算法。顾名思义，轮询分发请求。                   | 实现简单              | 不考虑每台服务器的处理能力 |
| wrr 加权调度算法。我们给每个服务器设置权值weight，负载均衡调度器根据权值调度服务器，服务器被调用的次数跟权值成正比 | 考虑了服务器处理能力的不同     |               |
| sh 原地址散列：提取用户IP，根据散列函数得出一个key，再根据静态映射表，查处对应的value，即目标服务器IP。若目标机器超负荷，则返回空。 | 同一个用户访问同一个服务器     |               |
| dh 目标地址散列：同上，只是现在提取的是目标地址的IP来做哈希         | 同一个用户访问同一个服务器     |               |
| lc 最少连接。优先把请求转发给连接数少的服务器                 | 使得集群中各个服务器的负载更加均匀 |               |
| wlc 加权最少连接。在lc的基础上，为每台服务器加上权值。算法为：（活动连接数*256+非活动连接数）÷权重 ，计算出来的值小的服务器优先被选择 | 可以根据服务器的能力分配请求    |               |
| sed 最短期望延迟。其实sed跟wlc类似，区别是不考虑非活动连接数。算法为：（活动连接数+1)*256÷权重，同样计算出来的值小的服务器优先被选择 |                   |               |
| nq 永不排队。改进的sed算法。我们想一下什么情况下才能“永不排队”，那就是服务器的连接数为0的时候，那么假如有服务器连接数为0，均衡器直接把请求转发给它，无需经过sed的计算 |                   |               |
| LBLC 基于局部性的最少连接。均衡器根据请求的目的IP地址，找出该IP地址最近被使用的服务器，把请求转发之，若该服务器超载，最采用最少连接数算法 |                   |               |
| LBLCR 带复制的基于局部性的最少连接。均衡器根据请求的目的IP地址，找出该IP地址最近使用的“服务器组”，注意，并不是具体某个服务器，然后采用最少连接数从该组中挑出具体的某台服务器出来，把请求转发之。若该服务器超载，那么根据最少连接数算法，在集群的非本服务器组的服务器中，找出一台服务器出来，加入本服务器组，然后把请求转发之 |                   |               |



# 读写分离

MySql主从配置，读写分离并引入中间件，开源的**MyCat**，阿里的**DRDS**都是不错的选择。

如果是对高可用要求比较高，但是又没有相应的技术保障，建议使用阿里云的RDS或者Redis相关数据库，省事省力又省钱。



# 全文检索

搜索业务，使用solr或elasticsearch。



# 缓存优化

引入缓存，减轻后端数据库服务的压力，常见的缓存服务有：Ehcache、OsCache、MemCache、Redis。



# 消息队列

异步通知：比如短信验证，邮件验证这些**非实时**反馈性的逻辑操作。

![](https://blog.52itstyle.com/usr/uploads/2017/08/55576777.png?_=7476838)



**流量削锋**：应该是消息队列中的常用场景，一般在秒杀或团抢活动中使用广泛。

**日志处理**：系统中日志是必不可少的，但是如何去处理高并发下的日志确是一个技术活，一不小心可能会压垮整个服务。工作中我们常用到的开源日志***ELK***，为嘛中间会加一个**Kafka或者redis**就是这么一个道理(一群人涌入和排队进的区别)。

**消息通讯**：***点对点***通信(个人对个人)或***发布订阅***模式(聊天室)。



# 日志服务

消息队列中提到的[ELK开源日志](https://blog.52itstyle.com/archives/679/)组间对于中小型创业供公司是一个不错的选择。

 ![日志处理流程](C:\Users\admin\Downloads\日志处理流程.png)

# 安全优化

- 阿里云的VPN虚拟专有网络以及安全组配置
- 自建机房的话，要自行配置防火墙安全策略
- 相关服务访问，比如Mysql、Redis、Solr等如果没有特殊需求尽量使用内网访问并设置鉴权
- 尽量使用代理服务器，不要对外开放过多的端口
- https配合HTTP/2.0也是个不错的选择



# 附录：

## 架构热词

### 高可用

- 负载均衡（负载均衡算法）
- 反向代理
- 服务隔离
- 服务限流
- 服务降级（自动优雅降级）
- 失效转移
- 超时重试（代理超时、容器超时、前端超时、中间件超时、数据库超时、NoSql超时）
- 回滚机制（上线回滚、数据库版本回滚、事务回滚）

### 高并发

- 应用缓存
- HTTP缓存
- 多级缓存
- 分布式缓存
- 连接池
- 异步并发

### 分布式事务

- 二阶段提交(强一致)

- 三阶段提交(强一致)

- 消息中间件(最终一致性)，推荐阿里的RocketMQ

  ![](https://blog.52itstyle.com/usr/uploads/2017/09/2959633295.jpg?_=7476838)

### 队列

- 任务队列
- 消息队列
- 请求队列

### 扩容

- 单体垂直扩容
- 单体水平扩容
- 应用拆分
- 数据库拆分
- 数据库分库分表
- 数据异构
- 分布式任务

### 网络安全

- SQL注入
- XSS攻击
- CSRF攻击
- 拒绝服务（DoS，Denial　of　Service）攻击

## 必备工具

### 操作系统

Linux（必备）、某软的、Mac

### 负载均衡

DNS、F5、LVS、Nginx、OpenResty、HAproxy、负载均衡SLB（阿里云）

### 分布式框架

Dubbo、Motan、Spring-Cloud

### 数据库中间件

DRDS （阿里云）、Mycat、360 Atlas、Cobar (不维护了)

### 消息队列

RabbitMQ、ZeroMQ、Redis、ActiveMQ、Kafka

### 注册中心

Zookeeper、Redis

### 缓存

Redis、Oscache、Memcache、Ehcache

### 集成部署

Docker、Jenkins、Git、Maven

### 存储

OSS、NFS、FastDFS、MogileFS

### 数据库

MySql、Redis、MongoDB、PostgreSQL、Memcache、HBase

### 网络

专用网络VPC、弹性公网IP、CDN



## 参考：

[小柒网站技术架构总结 ](https://blog.52itstyle.com/archives/1447/#题记)

